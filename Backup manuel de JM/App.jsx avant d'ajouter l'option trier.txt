import { useState, useEffect } from 'react';
import { database } from './firebase';
import { ref, onValue, push, set, remove } from 'firebase/database';
import Setup from './components/Setup';
import TransactionForm from './components/TransactionForm';
import Summary from './components/Summary';
import CategoriesModal from './components/CategoriesModal';
import { DEFAULT_CATEGORIES } from './constants/categories';
import { formatAmount, formatDate } from './utils/formatters';
import './App.css';

function App() {
  const [isSetup, setIsSetup] = useState(false);
  const [session, setSession] = useState(null);
  const [transactions, setTransactions] = useState([]);
  const [personalTransactions, setPersonalTransactions] = useState([]);
  const [categories, setCategories] = useState(DEFAULT_CATEGORIES);
  const [activeTab, setActiveTab] = useState('add');
  const [currentUserName, setCurrentUserName] = useState('');
  const [editingTransaction, setEditingTransaction] = useState(null);
  const [selectedMonth, setSelectedMonth] = useState(new Date());
  const [showOptionsMenu, setShowOptionsMenu] = useState(false);
  const [showCategoriesModal, setShowCategoriesModal] = useState(false);

  // V√©rifie si une session existe au d√©marrage
  useEffect(() => {
    const savedSession = localStorage.getItem('budgetduo_session');
    if (savedSession) {
      try {
        const sessionData = JSON.parse(savedSession);
        setSession(sessionData);
        setIsSetup(true);
        setCurrentUserName(sessionData.userName);
      } catch (error) {
        console.error('Session invalide, nettoyage...', error);
        localStorage.removeItem('budgetduo_session');
        setIsSetup(false);
      }
    }
  }, []);

  // Charge les transactions partag√©es
  useEffect(() => {
    if (session?.code) {
      const transactionsRef = ref(database, `sessions/${session.code}/transactions`);
      
      onValue(transactionsRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const transactionsList = Object.entries(data).map(([id, trans]) => ({
            id,
            ...trans
          }));
          setTransactions(transactionsList);
        } else {
          setTransactions([]);
        }
      });

      // Charge les cat√©gories
      const categoriesRef = ref(database, `sessions/${session.code}/categories`);
      onValue(categoriesRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          setCategories(data);
        } else {
          set(categoriesRef, DEFAULT_CATEGORIES);
        }
      });
    }
  }, [session]);

  // Charge les transactions personnelles
  useEffect(() => {
    if (session?.code && currentUserName) {
      const personalRef = ref(database, `sessions/${session.code}/personal/${currentUserName}/transactions`);
      
      onValue(personalRef, (snapshot) => {
        const data = snapshot.val();
        if (data) {
          const personalList = Object.entries(data).map(([id, trans]) => ({
            id,
            ...trans
          }));
          setPersonalTransactions(personalList);
        } else {
          setPersonalTransactions([]);
        }
      });
    }
  }, [session, currentUserName]);

  // Callback quand le setup est compl√©t√©
  const handleSetupComplete = (sessionData) => {
    setSession(sessionData);
    setIsSetup(true);
    setCurrentUserName(sessionData.userName);
  };

  // Ajoute ou modifie une transaction
  const handleAddTransaction = (transaction) => {
    if (transaction.id) {
      // MODIFICATION d'une transaction existante
      if (transaction.isPersonal) {
        const transactionRef = ref(database, `sessions/${session.code}/personal/${currentUserName}/transactions/${transaction.id}`);
        set(transactionRef, transaction);
      } else {
        const transactionRef = ref(database, `sessions/${session.code}/transactions/${transaction.id}`);
        set(transactionRef, transaction);
      }
    } else {
      // AJOUT d'une nouvelle transaction
      if (transaction.isPersonal) {
        const personalRef = ref(database, `sessions/${session.code}/personal/${currentUserName}/transactions`);
        const newTransactionRef = push(personalRef);
        set(newTransactionRef, transaction);
      } else {
        const transactionsRef = ref(database, `sessions/${session.code}/transactions`);
        const newTransactionRef = push(transactionsRef);
        set(newTransactionRef, transaction);
      }
    }
    
    // R√©initialise l'√©dition
    setEditingTransaction(null);
    setActiveTab(transaction.isPersonal ? 'personal' : 'list');
  };

  // Commence l'√©dition d'une transaction
  const handleEditTransaction = (transaction, isPersonal) => {
    setEditingTransaction({ ...transaction, isPersonal });
    setActiveTab('add');
  };

  // Sauvegarde les cat√©gories
  const handleSaveCategories = (newCategories) => {
    const categoriesRef = ref(database, `sessions/${session.code}/categories`);
    set(categoriesRef, newCategories);
    setCategories(newCategories);
  };

  // Navigation mensuelle
  const goToPreviousMonth = () => {
    setSelectedMonth(prevMonth => {
      const newDate = new Date(prevMonth);
      newDate.setMonth(newDate.getMonth() - 1);
      return newDate;
    });
  };

  const goToNextMonth = () => {
    setSelectedMonth(prevMonth => {
      const newDate = new Date(prevMonth);
      newDate.setMonth(newDate.getMonth() + 1);
      return newDate;
    });
  };

  const goToCurrentMonth = () => {
    setSelectedMonth(new Date());
  };

  // Formatte le mois s√©lectionn√©
  const formatSelectedMonth = () => {
    const options = { year: 'numeric', month: 'long' };
    return selectedMonth.toLocaleDateString('fr-CA', options);
  };

  // Filtre les transactions par mois
const filterTransactionsByMonth = (transactions) => {
  return transactions.filter(tx => {
    // Parse la date comme "YYYY-MM-DD" en local
    const [year, month, day] = tx.date.split('-').map(Number);
    const txDate = new Date(year, month - 1, day); // month - 1 car les mois commencent √† 0
    
    return txDate.getMonth() === selectedMonth.getMonth() && 
           txDate.getFullYear() === selectedMonth.getFullYear();
  });
};

  // Si pas encore configur√©, affiche le Setup
  if (!isSetup) {
    return <Setup onComplete={handleSetupComplete} />;
  }

  // Filtrer les transactions partag√©es par mois
  const sharedTransactions = filterTransactionsByMonth(
    transactions.filter(tx => !tx.isPersonal)
  );

  // Filtrer les transactions personnelles par mois
  const filteredPersonalTransactions = filterTransactionsByMonth(personalTransactions);

  return (
    <div className="app-container">
      <div className="header">
        <h1>üí∞ BudgetDuo</h1>
        <p className="header-users">{session.userName} & {session.partnerName}</p>
        
        <div className="header-settings">
          <button 
            className="header-settings-button"
            onClick={() => setShowOptionsMenu(!showOptionsMenu)}
            title="Options"
          >
            ‚öôÔ∏è
          </button>
          
          {showOptionsMenu && (
            <div className="options-menu">
              <button
                className="option-item"
                onClick={() => {
                  setShowCategoriesModal(true);
                  setShowOptionsMenu(false);
                }}
              >
                üè∑Ô∏è G√©rer les cat√©gories
              </button>
              <button
                className="option-item danger"
                onClick={() => {
                  if (confirm('Voulez-vous vraiment r√©initialiser la configuration ?')) {
                    localStorage.removeItem('budgetduo_session');
                    setIsSetup(false);
                    setSession(null);
                  }
                  setShowOptionsMenu(false);
                }}
              >
                üîÑ R√©initialiser
              </button>
            </div>
          )}
        </div>
        
        {/* S√©lecteur de mois */}
        <div className="header-month-selector">
          <button 
            className="header-month-btn"
            onClick={goToPreviousMonth}
            title="Mois pr√©c√©dent"
          >
            ‚Üê
          </button>
          <div className="header-month-display">
            <span className="header-month-text">{formatSelectedMonth()}</span>
            <button 
              className="header-today-btn"
              onClick={goToCurrentMonth}
            >
              Aujourd'hui
            </button>
          </div>
          <button 
            className="header-month-btn"
            onClick={goToNextMonth}
            title="Mois suivant"
          >
            ‚Üí
          </button>
        </div>
      </div>

      {/* Modal Cat√©gories */}
      {showCategoriesModal && (
        <CategoriesModal
          categories={categories}
          onSave={handleSaveCategories}
          onClose={() => setShowCategoriesModal(false)}
        />
      )}

      {/* Navigation par onglets */}
      <div className="tabs-navigation">
        <button
          className={`tab-btn ${activeTab === 'add' ? 'active' : ''}`}
          onClick={() => setActiveTab('add')}
        >
          ‚ûï Ajouter
        </button>
        <button
          className={`tab-btn ${activeTab === 'list' ? 'active' : ''}`}
          onClick={() => setActiveTab('list')}
        >
          üìã Liste {sharedTransactions.length > 0 && `(${sharedTransactions.length})`}
        </button>
        <button
          className={`tab-btn ${activeTab === 'personal' ? 'active' : ''}`}
          onClick={() => setActiveTab('personal')}
        >
          üë§ Personnel {filteredPersonalTransactions.length > 0 && `(${filteredPersonalTransactions.length})`}
        </button>
      </div>

      {/* Contenu selon l'onglet actif */}
      <div className="tab-content">
        {/* Onglet Ajouter */}
        {activeTab === 'add' && (
          <TransactionForm 
            session={session}
            categories={categories}
            onSubmit={handleAddTransaction}
            editingTransaction={editingTransaction}
            onCancelEdit={() => setEditingTransaction(null)}
          />
        )}

        {/* Onglet Liste (transactions partag√©es) */}
        {activeTab === 'list' && (
          <>
            <Summary 
              transactions={sharedTransactions}
              session={session}
              categories={categories}
            />
            
            <div className="transactions-section">
              <h2>üìã Transactions partag√©es</h2>
              {sharedTransactions.length === 0 ? (
                <div className="empty-state">
                  <p>Aucune transaction pour ce mois.</p>
                </div>
              ) : (
                <div className="transactions-list">
                  {(() => {
                    // Grouper les transactions par date
                    const groupedByDate = {};
                    sharedTransactions
                      .sort((a, b) => b.timestamp - a.timestamp)
                      .forEach(tx => {
                        const dateKey = tx.date;
                        if (!groupedByDate[dateKey]) {
                          groupedByDate[dateKey] = [];
                        }
                        groupedByDate[dateKey].push(tx);
                      });

                    return Object.entries(groupedByDate).map(([date, txs]) => (
                      <div key={date} className="transaction-date-group">
                        <div className="transaction-date-header">{formatDate(date)}</div>
                        {txs.map(tx => (
                          <div key={tx.id} className="transaction-item-compact">
                            {tx.receiptPhoto ? (
                              <img 
                                src={tx.receiptPhoto} 
                                alt="Re√ßu"
                                className="transaction-receipt-thumb"
                                onClick={() => {
                                  const modal = document.createElement('div');
                                  modal.className = 'photo-modal';
                                  modal.innerHTML = `
                                    <div class="photo-modal-overlay">
                                      <img src="${tx.receiptPhoto}" alt="Re√ßu" class="photo-modal-image" />
                                      <button class="photo-modal-close">‚úï</button>
                                    </div>
                                  `;
                                  document.body.appendChild(modal);
                                  
                                  const img = modal.querySelector('.photo-modal-image');
                                  const closeBtn = modal.querySelector('.photo-modal-close');
                                  const overlay = modal.querySelector('.photo-modal-overlay');
                                  
                                  img.onclick = () => img.classList.toggle('zoomed');
                                  closeBtn.onclick = () => modal.remove();
                                  overlay.onclick = (e) => {
                                    if (e.target === overlay) modal.remove();
                                  };
                                }}
                              />
                            ) : (
                              <div className="transaction-icon-compact">
                                {categories[tx.category]?.icon || 'üì¶'}
                              </div>
                            )}
                            <div className="transaction-details-compact">
                              <div className="transaction-vendor-compact">{tx.vendor}</div>
                              <div className="transaction-payer">
                                {formatDate(tx.date)} ‚Ä¢ Pay√© par {tx.payer}
                              </div>
                            </div>
                            <div className={`transaction-amount-compact ${tx.type}`}>
                              {formatAmount(tx.amount, session.currency)}
                            </div>
                            <button
                              className="btn-edit-compact"
                              onClick={() => handleEditTransaction(tx, false)}
                              title="Modifier"
                            >
                              ‚úèÔ∏è
                            </button>
                          </div>
                        ))}
                      </div>
                    ));
                  })()}
                </div>
              )}
            </div>
          </>
        )}

        {/* Onglet Personnel */}
        {activeTab === 'personal' && (
          <>
         <Summary 
  transactions={[...sharedTransactions, ...filteredPersonalTransactions]}
  session={session}
  categories={categories}
/>
            
            <div className="transactions-section">
              <h2>üë§ Transactions personnelles</h2>
              {filteredPersonalTransactions.length === 0 ? (
                <div className="empty-state">
                  <p>Aucune transaction personnelle pour ce mois.</p>
                </div>
              ) : (
                <div className="transactions-list">
                  {(() => {
                    const groupedByDate = {};
                    filteredPersonalTransactions
                      .sort((a, b) => b.timestamp - a.timestamp)
                      .forEach(tx => {
                        const dateKey = tx.date;
                        if (!groupedByDate[dateKey]) {
                          groupedByDate[dateKey] = [];
                        }
                        groupedByDate[dateKey].push(tx);
                      });

                    return Object.entries(groupedByDate).map(([date, txs]) => (
                      <div key={date} className="transaction-date-group">
                        <div className="transaction-date-header">{formatDate(date)}</div>
                        {txs.map(tx => (
                          <div key={tx.id} className="transaction-item-compact">
                            {tx.receiptPhoto ? (
                              <img 
                                src={tx.receiptPhoto} 
                                alt="Re√ßu"
                                className="transaction-receipt-thumb"
                                onClick={() => {
                                  const modal = document.createElement('div');
                                  modal.className = 'photo-modal';
                                  modal.innerHTML = `
                                    <div class="photo-modal-overlay">
                                      <img src="${tx.receiptPhoto}" alt="Re√ßu" class="photo-modal-image" />
                                      <button class="photo-modal-close">‚úï</button>
                                    </div>
                                  `;
                                  document.body.appendChild(modal);
                                  
                                  const img = modal.querySelector('.photo-modal-image');
                                  const closeBtn = modal.querySelector('.photo-modal-close');
                                  const overlay = modal.querySelector('.photo-modal-overlay');
                                  
                                  img.onclick = () => img.classList.toggle('zoomed');
                                  closeBtn.onclick = () => modal.remove();
                                  overlay.onclick = (e) => {
                                    if (e.target === overlay) modal.remove();
                                  };
                                }}
                              />
                            ) : (
                              <div className="transaction-icon-compact">
                                {categories[tx.category]?.icon || 'üì¶'}
                              </div>
                            )}
                            <div className="transaction-details-compact">
                              <div className="transaction-vendor-compact">{tx.vendor}</div>
                              <div className="transaction-payer">
                                {formatDate(tx.date)} ‚Ä¢ Pay√© par {tx.payer}
                              </div>
                            </div>
                            <div className={`transaction-amount-compact ${tx.type}`}>
                              {formatAmount(tx.amount, session.currency)}
                            </div>
                            <button
                              className="btn-edit-compact"
                              onClick={() => handleEditTransaction(tx, true)}
                              title="Modifier"
                            >
                              ‚úèÔ∏è
                            </button>
                          </div>
                        ))}
                      </div>
                    ));
                  })()}
                </div>
              )}
            </div>
          </>
        )}
      </div>
    </div>
  );
}

export default App;